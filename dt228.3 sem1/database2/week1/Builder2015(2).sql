purge recyclebin;
-- drop bottom layer
--
DROP TABLE CORDERLINE;
DROP TABLE SORDERLINE;
--
-- drop second layer
--
DROP TABLE CORDER;
DROP SEQUENCE CORDSEQ;
DROP TABLE SORDER;
DROP SEQUENCE SORDSEQ;
DROP TABLE STOCK;
--
-- Drop top layer
--
DROP TABLE SUPPLIER;
DROP SEQUENCE SUPPSEQ;
DROP TABLE CUSTOMER;
DROP SEQUENCE CUSTSEQ;
DROP TABLE STAFF;
DROP SEQUENCE STAFFSEQ;
--
-- Create first layer of tables - no dependencies
--
CREATE TABLE Customer (
	Customer_Id        NUMBER(7) PRIMARY KEY,
	Customer_Name      VARCHAR2(25) not null,
	Customer_Address   VARCHAR2(80)
);
CREATE SEQUENCE CUSTSEQ START WITH 1;

CREATE TABLE Supplier (
	Supplier_Id        NUMBER(7)     PRIMARY KEY,
	Supplier_Name      VARCHAR2(25) not null,
	Supplier_Address   VARCHAR2(80) not null,
	Amount_Owed        NUMBER(10,2)
);
CREATE SEQUENCE SUPPSEQ START WITH 501;
CREATE TABLE Staff (
	Staff_no           NUMBER(7)     PRIMARY KEY,
	Staff_name 	   VARCHAR2(20) not null,
	Staff_role 	   VARCHAR2(10),
	Reports_to 	   NUMBER (7)    REFERENCES Staff(staff_no)
);
CREATE SEQUENCE STAFFSEQ START WITH 51;
--
-- Create second layer of tables - dependent on the first layer
--
CREATE TABLE Stock (
	Stock_Code        CHAR(5)   PRIMARY KEY,
	Stock_Description VARCHAR2(20) not null,
	Unit_Price        NUMBER(10,2) not null,
	UnitCostPrice     NUMBER(10,2) not null,
	Stock_level       NUMBER(7) not null,
	Reorder_level     NUMBER(7),
	Supplier_Id       NUMBER(7)     REFERENCES Supplier not null
);

CREATE TABLE COrder (
	corderno          NUMBER(7)    PRIMARY KEY,
	Order_Date        DATE default sysdate not null ,
	Customer_Id       NUMBER(7)    REFERENCES Customer not null,
	StaffPaid         NUMBER(7)    REFERENCES Staff(staff_no) not null,
	StaffIssued       NUMBER(7)    REFERENCES Staff(staff_no)
);
CREATE SEQUENCE CORDSEQ START WITH 100;

CREATE TABLE SOrder (
	SOrderNo   NUMBER(7)    PRIMARY KEY,
	SOrderDate DATE default sysdate not null,
	DeliveredDate     DATE         NULL,
	Supplier_Id NUMBER(7)          REFERENCES Supplier,
CONSTRAINT DATECHECK CHECK(DELIVEREDDATE >SORDERDATE)
);
CREATE SEQUENCE SORDSEQ START WITH 700;
--
-- Create third layer - dependent on the second layer.
--
CREATE TABLE COrderLine (
	QuantityRequired  NUMBER(8),
	Corderno          NUMBER(7)    REFERENCES Corder,
	Stock_Code        CHAR(5)  REFERENCES Stock,
	PRIMARY KEY (COrderno,stock_code)
);

CREATE TABLE SOrderline (
	StockRequired     NUMBER(8),
	SOrderNo          NUMBER(7)    REFERENCES Sorder not null,
	Stock_Code        CHAR(5)  REFERENCES Stock not null,
	PRIMARY KEY  (SOrderNo,Stock_Code)
);
--
DROP TABLE ERRORLOG;
DROP TABLE LOG_TABLE;
DROP TABLE RESTOCK;
--
  CREATE TABLE ERRORLOG 
   (	TABNAM VARCHAR2(20), 
	OP VARCHAR2(3), 
	OPUSER VARCHAR2(20), 
	OPDATE DATE, 
	MSG VARCHAR2(200)
   ) ;
 
 
  CREATE TABLE LOG_TABLE 
   (	OP CHAR(3) DEFAULT 'INS' NOT NULL , 
	TABNAM VARCHAR2(15) NOT NULL , 
	PRIMKEY VARCHAR2(10) NOT NULL , 
	LOGDATE DATE DEFAULT sysdate, 
	LOGUSER VARCHAR2(20) DEFAULT to_char(user), 
	 CHECK (op in ('INS','UPD','DEL')) );
 
  CREATE TABLE RESTOCK 
   (	RESTOCKDATE DATE, 
	SCODE CHAR(5)
   );
 --
-- Layer 1 Customer - staff - supplier
INSERT INTO CUSTOMER VALUES (CUSTSEQ.NEXTVAL, 'John Flaherty','23 The Green, Blackhill, Dublin 25.');
INSERT INTO CUSTOMER VALUES (CUSTSEQ.NEXTVAL, 'Gerard Temple','9 Genview Tce, Limerick');
INSERT INTO CUSTOMER VALUES (CUSTSEQ.NEXTVAL, 'John Browne','2 Kevin St., Dublin 8');
INSERT INTO CUSTOMER VALUES (CUSTSEQ.NEXTVAL, 'Aidan Bourke','64 Earlsfort Court, Dublin 8');
INSERT INTO CUSTOMER VALUES (CUSTSEQ.NEXTVAL, 'Mary Martin','33 The Lawn, Greenhills, Dublin 22');
INSERT INTO CUSTOMER VALUES (CUSTSEQ.NEXTVAL, 'Handy Andy','Television land');
INSERT INTO CUSTOMER VALUES (CUSTSEQ.NEXTVAL, 'Mary Poppins','34 Greygates, Mt. Merrion');
--
--
--
INSERT INTO staff(STAFF_NO,STAFF_NAME,STAFF_ROLE) VALUES (STAFFSEQ.NEXTVAL, 'Joe Owner','Owner');
INSERT INTO staff VALUES (STAFFSEQ.NEXTVAL, 'Fred Flinstone','Foreman',51);
INSERT INTO staff VALUES (STAFFSEQ.NEXTVAL, 'Robbie Redstone','Sales',51);
INSERT INTO staff VALUES (STAFFSEQ.NEXTVAL, 'Paul Moran','Foreman',52);
INSERT INTO staff VALUES (STAFFSEQ.NEXTVAL, 'Mick O''Donnell','Sales',53);
--
--
--
INSERT INTO Supplier VALUES (SUPPSEQ.NEXTVAL, 'Buckleys','Quarry town, Quarrysville, D44.',6999.5);
INSERT INTO Supplier VALUES (SUPPSEQ.NEXTVAL, 'Brendan Moore','44 Kevin St., D8',4444);
INSERT INTO Supplier VALUES (SUPPSEQ.NEXTVAL, 'James McGovern','33 Synge St.',4443);
INSERT INTO Supplier VALUES (SUPPSEQ.NEXTVAL, 'Liam Keenan','33 Mount Vernon Ave',8888);
INSERT INTO Supplier VALUES (SUPPSEQ.NEXTVAL, 'Mary O''Brien','Appian Way, D2',33333);
INSERT INTO Supplier VALUES (SUPPSEQ.NEXTVAL, 'Oliver Moore','Georges St., D2',3321);
INSERT INTO Supplier VALUES (SUPPSEQ.NEXTVAL, 'Robert O''Mahony','Fitzwilliam Sq',2222);
INSERT INTO Supplier VALUES (SUPPSEQ.NEXTVAL, 'Patricia O''Brien','21 Liberty Lane, D8',3000);
INSERT INTO Supplier VALUES (SUPPSEQ.NEXTVAL, 'June Browne','33 Liberty Lane',4000);
INSERT INTO Supplier VALUES (SUPPSEQ.NEXTVAL, 'Paul Sloan','44 Liberty Lane',30000);
INSERT INTO Supplier VALUES (SUPPSEQ.NEXTVAL, 'Kevin Kelly','33 Bride St, D8',4444);
--
--  Layer 2 - Stock - Sorder - Corder
--
--SELECT SUPPSEQ.CURRVAL FROM DUAL;
INSERT INTO Stock VALUES ('BRK11', 'Brick - red, 30x100',2.5,1.5,750,100,501);
INSERT INTO Stock VALUES ('A101', 'Cavity blocks(100)',200,500,300,100,501);
INSERT INTO Stock VALUES ('A111', 'Red bricks(100)',200,250,294,100,501);
INSERT INTO Stock VALUES ('B101', '2"x4" lengths',9.5,7,40,45,504);
INSERT INTO Stock VALUES ('B111', 'Window Frames 2''x4''',45,38,10,5,508);
INSERT INTO Stock VALUES ('C101', '6" Nails(50)',5.95,5,30,25,510);
INSERT INTO Stock VALUES ('C121', '6" Nails(100)',9.95,8,20,25,510);
INSERT INTO Stock VALUES ('D101', 'Workbench',250,200,138,1,511);
INSERT INTO Stock VALUES ('D131', 'cordless Drill',200,150,30,10,506);
INSERT INTO Stock VALUES ('E101', 'Cavity blocks(500)',1000,500,172,200,501);
INSERT INTO Stock VALUES ('E141', 'Cavity blocks(200)',400,130,300,200,501);
INSERT INTO Stock VALUES ('A642', '4"x4" treated timber',9.5,8,20,5,510);
INSERT INTO Stock VALUES ('J555', 'Box of 6" screws',5,4,100,10,508);
INSERT INTO Stock VALUES ('J501', 'Phillips screwdriver',8,6,38,10,505);
INSERT INTO STOCK VALUES ('B141', 'U-lock bicycle lock', 19.99,15,40,10,510);
INSERT INTO STOCK VALUES ('B142', 'Unicycle', 300,499.99,5,1,510);
--
-- PLACE AN ORDER WITH EACH SUPPLIER
/*SELECT SUPPLIER_ID FROM SUPPLIER MINUS
SELECT SUPPLIER_ID FROM SUPPLIER WHERE SUPPLIER_ID NOT IN (SELECT SUPPLIER_ID FROM STOCK);
--
-- SUPPLIERS ARE 501, 504, 505, 506, 508, 510 AND 511.
*/
INSERT INTO SORDER (SORDERNO, SORDERDATE,DELIVEREDDATE, SUPPLIER_ID) VALUES (SORDSEQ.NEXTVAL, SYSDATE-500, SYSDATE-480, 501);--700
INSERT INTO SORDER (SORDERNO, SORDERDATE, SUPPLIER_ID) VALUES (SORDSEQ.NEXTVAL, SYSDATE-5, 501);--701

INSERT INTO SORDER (SORDERNO, SORDERDATE,DELIVEREDDATE, SUPPLIER_ID) VALUES (SORDSEQ.NEXTVAL, SYSDATE-50, SYSDATE-48, 504);--703
INSERT INTO SORDER (SORDERNO, SORDERDATE,DELIVEREDDATE, SUPPLIER_ID) VALUES (SORDSEQ.NEXTVAL, SYSDATE-5, SYSDATE-4, 504);--704
INSERT INTO SORDER (SORDERNO, SORDERDATE, SUPPLIER_ID) VALUES (SORDSEQ.NEXTVAL, SYSDATE, 504);--705
--
INSERT INTO SORDER (SORDERNO, SORDERDATE, SUPPLIER_ID) VALUES (SORDSEQ.NEXTVAL, SYSDATE-10, 505);--706
INSERT INTO SORDER (SORDERNO, SORDERDATE,DELIVEREDDATE, SUPPLIER_ID) VALUES (SORDSEQ.NEXTVAL, SYSDATE-50, SYSDATE-48, 505);--707
INSERT INTO SORDER (SORDERNO, SORDERDATE,DELIVEREDDATE, SUPPLIER_ID) VALUES (SORDSEQ.NEXTVAL, SYSDATE-5, SYSDATE-4, 506);--708
--
INSERT INTO SORDER (SORDERNO, SORDERDATE,DELIVEREDDATE, SUPPLIER_ID) VALUES (SORDSEQ.NEXTVAL, SYSDATE-500, SYSDATE-480, 506);--709
INSERT INTO SORDER (SORDERNO, SORDERDATE,DELIVEREDDATE, SUPPLIER_ID) VALUES (SORDSEQ.NEXTVAL, SYSDATE-50, SYSDATE-48, 508);--710
INSERT INTO SORDER (SORDERNO, SORDERDATE,DELIVEREDDATE, SUPPLIER_ID) VALUES (SORDSEQ.NEXTVAL, SYSDATE-5, SYSDATE-4, 508);--711
INSERT INTO SORDER (SORDERNO, SORDERDATE, SUPPLIER_ID) VALUES (SORDSEQ.NEXTVAL, SYSDATE-5, 510);--712
INSERT INTO SORDER (SORDERNO, SORDERDATE, SUPPLIER_ID) VALUES (SORDSEQ.NEXTVAL, SYSDATE, 511);--713
insert into sorder values (720,'01-Jan-2015', '01-Mar-2015',501);



----
/*SELECT * FROM SORDER;*/
--
-- sorderline - 
--
--SELECT STOCK_CODE FROM STOCK WHERE SUPPLIER_ID = 501;
--  501 SUPPLIER ORDERS
INSERT INTO SORDERLINE VALUES (18,SORDSEQ.CURRVAL-12,'BRK11');    --701       
INSERT INTO SORDERLINE VALUES (14,SORDSEQ.CURRVAL-12,'A101');    --701       
INSERT INTO SORDERLINE VALUES (27,SORDSEQ.CURRVAL-12,'E101');    -- 707   
INSERT INTO SORDERLINE VALUES (23,SORDSEQ.CURRVAL-12,'A111');           
INSERT INTO SORDERLINE VALUES (24,SORDSEQ.CURRVAL-12,'E141'); 
INSERT INTO SORDERLINE VALUES (18,SORDSEQ.CURRVAL-11,'BRK11');    --701       
INSERT INTO SORDERLINE VALUES (14,SORDSEQ.CURRVAL-11,'A101');    --701       
INSERT INTO SORDERLINE VALUES (25,SORDSEQ.CURRVAL-11,'E101');    -- 707   
INSERT INTO SORDERLINE VALUES (24,SORDSEQ.CURRVAL-11,'A111');           
INSERT INTO SORDERLINE VALUES (24,SORDSEQ.CURRVAL-11,'E141');    

--SELECT STOCK_CODE FROM STOCK WHERE SUPPLIER_ID = 504;
--  504 SUPPLIER ORDERS
INSERT INTO SORDERLINE VALUES (24,SORDSEQ.CURRVAL-10,'B101'); 
INSERT INTO SORDERLINE VALUES (18,SORDSEQ.CURRVAL-9,'B101');    --701       
--SELECT STOCK_CODE FROM STOCK WHERE SUPPLIER_ID = 505;
--  505 SUPPLIER ORDERS
INSERT INTO SORDERLINE VALUES (24,SORDSEQ.CURRVAL-7,'J501'); 
INSERT INTO SORDERLINE VALUES (18,SORDSEQ.CURRVAL-6,'J501');    --701       
--SELECT STOCK_CODE FROM STOCK WHERE SUPPLIER_ID = 506;
--  506 SUPPLIER ORDERS
INSERT INTO SORDERLINE VALUES (24,SORDSEQ.CURRVAL-5,'D131'); 

--SELECT STOCK_CODE FROM STOCK WHERE SUPPLIER_ID = 511;
--  506 SUPPLIER ORDERS
INSERT INTO SORDERLINE VALUES (24,SORDSEQ.CURRVAL-3,'B111'); 
INSERT INTO SORDERLINE VALUES (18,SORDSEQ.CURRVAL-3,'J555');    --701       

INSERT INTO SORDERLINE VALUES (3,SORDSEQ.CURRVAL-2,'J555');           
INSERT INTO SORDERLINE VALUES (3,SORDSEQ.CURRVAL-1,'C101');           
INSERT INTO SORDERLINE VALUES (3,SORDSEQ.CURRVAL-1,'C121');           
INSERT INTO SORDERLINE VALUES (3,SORDSEQ.CURRVAL-1,'A642');           
INSERT INTO SORDERLINE VALUES (3,SORDSEQ.CURRVAL-1,'B141');           
INSERT INTO SORDERLINE VALUES (3,SORDSEQ.CURRVAL-1,'B142');         
INSERT INTO SORDERLINE VALUES (3,SORDSEQ.CURRVAL,'D101'); 

insert into sorderline values (4, 720, 'E101');
--
/*
SELECT * FROM SORDERLINE;*/
INSERT INTO CORDER(CORDERNO, ORDER_DATE, CUSTOMER_ID, STAFFPAID, STAFFISSUED) VALUES (CORDSEQ.NEXTVAL,SYSDATE-500,CUSTSEQ.CURRVAL-6,53,52);
INSERT INTO CORDER(CORDERNO, ORDER_DATE, CUSTOMER_ID, STAFFPAID, STAFFISSUED) VALUES (CORDSEQ.NEXTVAL,SYSDATE-580,CUSTSEQ.CURRVAL-5,51,52);
INSERT INTO CORDER(CORDERNO, ORDER_DATE, CUSTOMER_ID, STAFFPAID, STAFFISSUED) VALUES (CORDSEQ.NEXTVAL,SYSDATE-504,CUSTSEQ.CURRVAL-3,53,54);
INSERT INTO CORDER(CORDERNO, ORDER_DATE, CUSTOMER_ID, STAFFPAID, STAFFISSUED) VALUES (CORDSEQ.NEXTVAL,SYSDATE-500,CUSTSEQ.CURRVAL-1,55,51);
INSERT INTO CORDER(CORDERNO, ORDER_DATE, CUSTOMER_ID, STAFFPAID, STAFFISSUED) VALUES (CORDSEQ.NEXTVAL,SYSDATE-500,CUSTSEQ.CURRVAL-6,53,54);
INSERT INTO CORDER (CORDERNO, ORDER_DATE, CUSTOMER_ID, STAFFPAID, STAFFISSUED) VALUES (CORDSEQ.NEXTVAL,SYSDATE-500,CUSTSEQ.CURRVAL-6,51,54);
INSERT INTO CORDER (CORDERNO, ORDER_DATE, CUSTOMER_ID, STAFFPAID, STAFFISSUED) VALUES (CORDSEQ.NEXTVAL,SYSDATE-500,CUSTSEQ.CURRVAL-3,53,51);
INSERT INTO CORDER (CORDERNO, ORDER_DATE, CUSTOMER_ID, STAFFPAID) VALUES (CORDSEQ.NEXTVAL,SYSDATE-500,CUSTSEQ.CURRVAL-1,53);
INSERT INTO CORDER (CORDERNO, ORDER_DATE, CUSTOMER_ID, STAFFPAID) VALUES (CORDSEQ.NEXTVAL,SYSDATE-500,CUSTSEQ.CURRVAL-6,55);
--
--  Layer 3 - corderline, sorderline

INSERT INTO CORDERLINE VALUES (1,CORDSEQ.CURRVAL-8,'A101');           
INSERT INTO CORDERLINE VALUES (2,CORDSEQ.CURRVAL-8,'A111');            
INSERT INTO CORDERLINE VALUES (3,CORDSEQ.CURRVAL-8,'A642');           
INSERT INTO CORDERLINE VALUES (3,CORDSEQ.CURRVAL-8,'B101');           
INSERT INTO CORDERLINE VALUES (3,CORDSEQ.CURRVAL-4,'B111');           
INSERT INTO CORDERLINE VALUES (2,CORDSEQ.CURRVAL-4,'B141');           
INSERT INTO CORDERLINE VALUES (2,CORDSEQ.CURRVAL-4,'BRK11');          
INSERT INTO CORDERLINE VALUES (1,CORDSEQ.CURRVAL-4,'C101');           
INSERT INTO CORDERLINE VALUES (1,CORDSEQ.CURRVAL-3,'C121');           
INSERT INTO CORDERLINE VALUES (1,CORDSEQ.CURRVAL-3,'D101');           
INSERT INTO CORDERLINE VALUES (1,CORDSEQ.CURRVAL-3,'D131');           
INSERT INTO CORDERLINE VALUES (1,CORDSEQ.CURRVAL,'E101');           
INSERT INTO CORDERLINE VALUES (1,CORDSEQ.CURRVAL,'E141');           
INSERT INTO CORDERLINE VALUES (1,CORDSEQ.CURRVAL,'J501');           
INSERT INTO CORDERLINE VALUES (1,CORDSEQ.CURRVAL,'J555'); 
INSERT INTO CORDERLINE VALUES (1,CORDSEQ.CURRVAL-7,'E101');           
INSERT INTO CORDERLINE VALUES (1,CORDSEQ.CURRVAL-1,'E141');           
INSERT INTO CORDERLINE VALUES (1,CORDSEQ.CURRVAL-2,'J501');           
INSERT INTO CORDERLINE VALUES (1,CORDSEQ.CURRVAL-5,'J555');

commit;
PURGE RECYCLEBIN;
GRANT SELECT ON STOCK TO PUBLIC;
GRANT SELECT ON SUPPLIER TO PUBLIC;
GRANT SELECT ON SORDER TO PUBLIC;
GRANT SELECT ON SORDERLINE TO PUBLIC;
GRANT SELECT ON CUSTOMER TO PUBLIC;
GRANT SELECT ON STAFF TO PUBLIC;
GRANT SELECT ON CUSTOMER TO PUBLIC;
GRANT SELECT ON CORDER TO PUBLIC;
GRANT SELECT ON CORDERLINE TO PUBLIC;



--SELECT * FROM SORDERLINE WHERE STOCK_CODE = 'E141'

select Stock_Code, Stock_Description
from STOCK
where Unit_Price < UnitCostPrice;

select Stock_Code, Stock_Description
from STOCK
where Reorder_level > 50;

select Customer_Name
from Customer
where not exists(
select * from COrder where COrder.Customer_Id = Customer.Customer_Id);

select Stock_Description
from STOCK
join COrderLine using(Stock_Code)
join COrder using(corderno)
join Customer using(Customer_Id)
where Customer_Name like 'Handy Andy';